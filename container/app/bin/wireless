#!/bin/bash

if [[ $UID != 0 ]]; then
    echo "Please run this script with sudo:"
    echo "sudo $0 $*"
    exit 1
fi

LANTERN_SSID="LANTERN"
LANTERN_INTERNET_SSID="LANTERN-INTERNET"

#-----------------------------------------------------------------------------

###
# Clear wlan0 interface regardless of state and start fresh
###
reset() {
  create_ap --stop wlan0
  netctl stop tether
  sleep 1
  systemctl stop netctl-auto@wlan0
  sleep 1
  ifconfig wlan0 down
  sleep 1
  rfkill block wlan
  sleep 1
  rfkill unblock wlan
  sleep 1
  ifconfig wlan0 up
  sleep 1
}


###
# Register wireless credentials to tether to existing wireless router
##
register() {
  wifi_ssid=$1
  echo "registering new wireless network: $wifi_ssid"
  
  echo "encrypting wifi pass..."
  wifi_pass=`wpa_passphrase ${wifi_ssid} <<< ${2} | grep -oE '(psk=)[a-zA-Z0-9]*$' | tr -d 'psk='`

  if [[ -f /etc/netctl/tether ]]; then
    rm /etc/netctl/tether > /dev/null
  fi

  touch /etc/netctl/tether
  cat <<EOF >"/etc/netctl/tether"
  Description="Lantern - Tether to Wireless Router"
  Interface=wlan0
  Connection=wireless
  Security=wpa
  ESSID="${wifi_ssid}"
  IP=dhcp
  Key="${wifi_pass}"
EOF
  echo "wrote new netctl file named: tether"
}


###
# tether to existing wireless router
###
tether() {
  echo "preparing tether to wireless router..."
  create_ap --stop wlan0
  sleep 5
  netctl start tether
  echo "tether mode enabled..."
}


###
# Stand-alone access point
###
ap() {
  ssid=${1:-$LANTERN_SSID}
  echo "configuring access point: ${ssid}"
  echo "you will need to reconnect through a shared wireless network..."
  reset
  create_ap --redirect-to-localhost --daemon --no-virt -n wlan0 "$ssid"
}

###
# Access point with internet access
###
ap_internet() {
  ap $LANTERN_INTERNET_SSID
}

###
# Pollination mode
###
pollinate() {
  echo "preparing wireless pollinate..."
}

###
# Discover MAC addresses of nearby wireless devices for airing
###
macs() {
  iw wlan0 scan | grep "wlan0\|SSID:\|signal" | paste - - - | grep "^BSS" | grep -v associated | sort -u -k3 | grep $2 | cut -c 5-21
}

help() {
  echo "Please choose between network modes: ap, ap_internet, tether, pollinate"
}

#-----------------------------------------------------------------------------

until
    cmd=$1
    if [ -z "$cmd" ]; then
        help
    fi
    shift 1
    $cmd "$@"
    [ "$?" -ne 127 ]
do
    help
    exit
done
